# 拜占庭问题
[TOC]
本文主要学习拜占庭相关知识，基于文章：比特币时代的拜占庭将军们

# 引子
所有人都知道X是不够的。我们还需要所有人都知道所有人都知道X，以及所有人都知道所有人都知道所有人都知道X，就像是在拜占庭将军问题里的那样——这是个分布式数据处理中的经典的困难问题。

# 问题
拜占庭将军问题的基本描述：
当有三个将军，其中一个是指挥官的时候。我们希望：
* 如果指挥官是忠诚的，忠诚的将军将执行命令。
* 如果指挥官是叛徒，诚实的将军们会做出统一行动。

这个问题是无解的，原因在于如果一个忠诚的将军收到进攻的指令，他无法确定指挥官是否是叛徒所以无法做出进攻的行动。当他询问另一个将军时会得出撤退的指令：
* 如果指挥官是叛徒，他将传递撤退的指令给另一个将军。
* 如果将军是叛徒，那么将军通过篡改指令传递错误的指令。

但如果有四个将军的时候，问题就可以得到解决（比如OM算法）。或者推广到3f+1个将军，其中f是叛徒的个数。

# 异步拜占庭容错
异步网络中，节点不像上面的同步问题中会在小延迟下响应。节点可以假装失效，或者选择性回应。所以每个节点都不能等待所有其他节点响应后做出决断。

如果设计一个简单方法，即诚实的将军们约定在t时间内没有获得指挥官的命令就撤退，但如果指挥官也是诚实的（诚实节点的信息延迟也可能很高）那么算法就失效了。而如果我们逼迫不诚实节点也必须发送命令，那么就与我们不希望不诚实节点干扰决定矛盾。这就使分布式系统的FLP不可能理论：只要某个节点可能会不说话，就不存在一种确定的算法完成共识。

这个无解的根源来自分布式数据库的CAP理论：在节点可能失效的网络中，一致性和活性不可能同时完成。

# 弱中止条件下的拜占庭将军问题

弱中止假设是在异步问题中我们假设将军一定会发出命令，并且命令带有将军签名，那么两个在异步系统中的忠诚将军是否能达成一致。这种假设下异步问题仍然存在。当将军收到来自指挥官的命令时为了确定将军是否忠诚需要等待另一位将军的回信。但是另一位将军的答复时间不定，如果仍然规定时间t的话会造成与异步网络相同的问题。

#### 四将军的可解
当有四个将军的时候，可以通过收到两个相同命令的内容执行。有两种情况：
* 我收到来自指挥官的进攻和另一个将军的防守，由于命令带有将军签名所以可以得知将军是叛徒。那么可以等待另一个忠诚将军的命令就可以在三个将军之间达成共识。
* 我收到来自指挥官的进攻和另一个将军的进攻，就无法判断将军是否忠诚。但是因为没有两个叛徒所以可以确定进攻来自忠诚的将军。于是不管第三个将军和指挥官哪个是叛徒都可以在忠诚将军中达成共识。

在普遍情况下，有n个将军和k个不忠诚节点。由于将军命令有签名，我们可以视为其他恶意节点智能选择传输将军命令与其同谋或者选择沉默，可以把问题理解为指挥官是叛徒的情况下一共控制k个节点来让忠诚的将军不同步的问题。

为了保持活性，我们最多可以等待n-f个消息来防止恶意的沉默。目的就是找到一个阈值k使得忠诚节点接收到k个消息就可以做出决定。最糟糕的情况我们收到来自坏节点的f个进攻，其他好节点中n-f+1/2-1个节点收到进攻另外一半收到撤退。那么为了达成一致要能收到k=f+n-f+1/2-1=n+f+1/2个消息才能确认。只要：
$$
\frac{n+f+1}{2} < n-f\qquad n>3f+1
$$
就可以保证网络中的好节点做出的决策是一致的。

#### 假设
为了能够解决拜占庭容错，我们需要对异步网络进行一些同步性假设。不同的容错算法的问题都在于怎么做这个假设。

# BFT与前比特币的容错算法
比特币出现之前有一批不以比特币为应用场景的拜占庭容错算法出现。这类算法包括著名的PBFT，也包括之前的不那么practical的BFT，和后PBFT时代中提出了“投机型”BFT的Zyzzyva。

## 拜占庭将军问题到PBET的提出

通过拜占庭将军问题为拜占庭容错问题提供了：

* 在弱中止条件下的拜占庭将军问题的算法A。
* 解决异步拜占庭容错问题的范式：先做出某个假设S1，采用某个基于A的拜占庭容错算法F(A)来试图达到共识，然后，如果不成功，即满足某个退出条件T，则改变S1为S2，然后再采用F(A)。

在最早的算法里，一些由于恶意节点而不能做出决策的节点在一轮算法之后通过抛硬币来决定下一轮的状态，以此通过多轮算法降低达不成共识的可能。

拜占庭将军与拜占庭容错的区别在拜占庭将军问题假设有一个指挥官发令而容错问题是有不同想法的将军达成共识。容错问题中不能确定那个一定会给所有人发命令的节点。

## 实用拜占庭容错（PBFT）
PBFT中的F(A)将所有节点排号，轮流做指挥官并进行广播算法。并设置时间t在超过阈值时进入下一轮。下一轮状态$S_2$选择第二个节点做指挥官并进行广播算法，同时增加阈值。只要系统延迟不会一直增长那么PBFT就能获得共识。

算法主要通过循环的方式找出可以确信发出命令给每个人的节点，那么问题就与拜占庭将军相同。同时通过增加阈值来让问题设定尽量接近拜占庭将军问题。

## Zyzzyva
Zyzzyva引入了正常情况与非正常情况。即当在PBFT中选择一个指挥官的时候可能会遇到指挥官是好的并且网络也好的情况，那么就不需要那么复杂的运算。F'(A)先进入正常状态，如果没有达成一致则进入不正常状态并运行F(A)。在情况好时Zyzzyva会更快，但是情况不好时会更慢，因为需要先判断情况再进入F(A)。

这类算法最后演变成链式BFT，它将各种状况下的BFT算法按复杂度从小到大串起来，通过判断情况来选择运行哪个算法。

# 比特币
比特币通过引入奖励惩罚机制约束节点，让所有节点都能处于理想状态，即链式BFT最开始的O(N)复杂度的简单广播。

# 比特币后的BFT
比特币对节点的约束让大网络成为可能，这就引入的以前的BFT中没有的大网络共识问题。对于比特币对异步拜占庭共识的影响作者总结了：

#### 异步一致，同步活性
在异步网络中比特币仍然没有解决活性和一致性的问题。由于比特币网络是一个交易网络，在异步情况下保证链的一致比保证活性更重要。

#### BFT

* 准入门槛，避免无关节点
* 设定奖励机制，在此基础通过投机BFT实际上很少进入更复杂的BFT算法
* 更现实的网络设计，根据现实情况考虑异步问题，恶意节点可以做出的攻击而不是考虑所以可能的异步问题。
* 随机领袖选择，通过随机选择节点管理网络来降低合谋的可能。

#### 无限扩展、layer1和layer2
layer1和layer2通过修改共识算法、在主链锁定保证金并通过链下通道的方式来扩展主链。但是保持活性，一致性，安全性仍然不能同时满足。
