# 以太坊学习
本文档用于记录学习以太坊
[TOC]
# 术语
#### 什么是区块链
区块链通过区块之间引用父块和共识机制的数据库，以此来保障区块链中每一个块都需要整个网络的共识。以太坊使用权益证明共识，验证者必须质押以太币。

#### 以太坊
以太坊是一条区块链并包含一个以太坊虚拟机（EVM）。每个节点都可以储存一个EVM的状态并广播请求计算，请求计算后每个节点都会检查、验证并执行计算并广播新的状态变化。‘

#### 智能合约
每次以太坊交易不会重写代码，而是由程序开发者将程序上传到以太坊虚拟机，申请交易者请求使用不同的参数来执行这些代码片段。我们将这些代码片段称为智能合约。

#### 以太币
以太币是以太坊上的原生货币，用于激励不同的人贡献计算资源。任何广播交易都需要支付一定量的奖励来作为提供计算资源的补偿。以太币还通过鼓励指出不诚实行为，抵押货币和对新提议区块的投票来保证网络安全。

###### 以太币铸造与燃烧
以太币在创建新块的时候被铸造，提出交易的时候被燃烧。铸造的新币约$\frac{1}{8}$会给提议者，其余给验证者分配。每当提出交易时需要设定最高燃料费，其中网络会根据交易需求销毁基础燃料费。这样的机制可以让以太币发行量更加平衡并让交易费更加透明。

###### 以太币面额
以太币提供更小的面额来完成交易。：

|面额|ETH值|用途|
|----|----|----|
|Wei|$10^{-18}$|技术实施|
|Gwei| $10^{-9}$|燃料费|

#### 去中心化应用
去中心化应用（DAPP）以智能合约为基础在以太坊虚拟机上运作。

#### Web3
Web3的概念是不需要中心互联网公司而在区块链上运作的去中心化程序。Web3不需要授权，没有人能拒绝访问且图灵完备，但可扩展性和性能差。

#### 账户
以太坊有两种账户：
* 外部所有的账户（EOA），由任何有私钥的人控制。
* 合约帐户，部署到网络上的智能合约，由代码控制。

两者都可以接收发送ETH和token，与已部署的智能合约交互。区别在于合约账户由智能合约的代码逻辑控制而非私钥，需要成本来使用网络储存空间。
###### 数据结构
以太坊账户有四个字段：
* nonce：一个计数器，任何账户可以发起交易或创建合约的数量的最大值，为一个随机数，用来避免重防攻击。
* balance：账户中Wei的数量。
* codeHash：EVM上的账户代码，用以执行合约账户的代码片段。外部账户的codeHash为空字符串的哈希。
* storageRoot：对账户储存内容的哈希编码，默认情况为空。

###### 账户创建
外部账户创建时生成私钥，合约账户在合约部署到以太坊链时给出，在POS中还有验证者密钥，用来识别验证者。
#### 交易
交易是由账户发出，来更新以太坊网络的状态。提交的交易包括：
* from：发送者地址（只能是外部用户）
* to：接收地址，传输交易值或运行合约代码。
* signature：发送者的标识符，用私钥签署交易。
* nonce：表示账户的交易数量。
* value：转移的以太币数量。
* inputdata：可以包含任意数据的可选字段。
* gasLimit：最大燃料费。
* maxPriorityFeePerGas - 作为小费提供给验证者的已消耗燃料的最高价格
* maxFeePerGas - 愿意为交易支付的每单位燃料的最高费用（包括 baseFeePerGas 和 maxPriorityFeePerGas）

###### data
data字段前四个字节使用函数名称和参数的哈希指定执行函数，后面的数据为传入参数。

###### 交易类型
* 常规交易：从一个账户到另一个账户。
* 合约部署交易：没有to地址，data用于合约代码。
* 执行合约：与已部署合约进行交互，to为合约地址。

###### 关于燃料
常规交易需要21000单位燃料。根据maxFeePerGas可以得到转账所需要付的燃料费。所有未用于交易的燃料费都会退还给账户。

###### 交易生命周期
交易提交后，会被广播到各个节点、被验证者加入区块、最后确认区块。一旦区块被最后确认只能通过上十亿美元的攻击才能更改。

#### 区块
###### POS
* 区块的验证者需要质押32以太币，来防止不良行为。
* 每个slot中（12秒），会随机选择一个验证者提议区块，将交易打包运行到下一个状态并把区块传送给其他验证者。
* 验证者计算并同意下一个状态。
* 如果有两个冲突的区块，验证者将用分叉选择区块选择质押以太币最多的区块。

###### 区块数据结构

* slot：区块所属的时隙。
* proposer_index：提出区块的验证者id
* parent_root：上一个区块的哈希。
* state_root：状态对象的根哈希。
* body：定义如下

body的数据结构：
* randao_reveal用于选择下一个区块提议者的值。
* eth1_data：关于存款合约的值。
* graffiti：用于标记块的任意数据。
* proposer_slashings：将要惩罚的验证者列表。
* attester_slashings：将要惩罚的证明者列表。
* attestations：支持当前区块的认证列表。
* deposits：存款合约新增的存款。
* voluntary_exits：退出网络的验证者列表。
* sync_aggregate：用于服务青客户端的验证者子集。
* execution_payload：从执行客户端传来的交易。

attestations的数据结构：
* aggregation_bits：参与认证的验证者列表。
* data：见下。
* signature：所有认证验证者的聚合签名。

attestation 中data的数据结构：
* slot：认证从属的时隙。
* index：证明验证者的索引。
* source：上一个合理的检查点。
* target：最新的时段边界区块。

body中exclution_payload中的所有交易被执行会改变虚拟机状态，所有客户端执行其中的交易并确保新状态与state_root的状态相同。exclution_payload_header的数据结构：

* parent_hash：父块的哈希值。
* fee_recipient支付交易小费的地址。
* state_root应用此区块更改后的全局哈希。
* receipts_root：交易数据树的哈希。
* logs_bloom：包含事件日志的数据树。
* prev_randao：随机选择验证者用的值。
* block_number：当前区块编号。
* gas_limit：区块允许的最大燃料。
* gas_used：区块使用的实际燃料。
* timestamp：区块的时间。
* extra_data：作为原始字节的任意附加数据。
* base_fee_per_gas：基础费值。
* block_hash：执行区块的哈希。
* transactions_root：有效负载中交易的根哈希。
* withdrawal_root：有效负载中提款的根哈希。

exclution_payload与header相同，但是包含的是交易和提款的列表而不是根哈希。

withdraw的数据结构：
* address：提款账户地址。
* amount：提款金额。
* index：提款索引值。
* validatorIndex：验证者索引值。

###### 区块大小
区块大小目标为1500万燃料单位，最高可以是3000万。限制区块大小可以限制处理区块所需要的性能来控制集中化。

#### 以太坊虚拟机
